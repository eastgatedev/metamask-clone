# Phase 2 & 3: Network Management + UI Implementation Plan

**Date:** 2025-12-01
**Status:** ✅ COMPLETED

---

## Overview

Implement network management functionality and Phase 3 UI components (UI only, no blockchain integration) for the MetaMask Clone IntelliJ plugin.

**Default Network:** BNB Testnet (chainId: 97)
**Default Enabled Networks:** Testnets only (BNB Testnet, Sepolia, Mumbai)
**Phase 3 Scope:** UI components only - balance display, token list, send dialog, add token dialog (no actual blockchain calls)

---

## UI Design Decision

- **Full network bar** below the title showing current network name with dropdown arrow
- Clicking the bar opens a network selection dialog (similar to MetaMask's network.png reference)

---

## Architecture

### New Files to Create

```
src/main/kotlin/dev/eastgate/metamaskclone/
├── core/
│   └── network/
│       └── NetworkManager.kt          # State management for networks
├── ui/
│   ├── panels/
│   │   └── NetworkSelectorBar.kt      # Full-width network selector bar
│   └── dialogs/
│       ├── NetworkSelectionDialog.kt  # Network list dialog
│       └── AddCustomNetworkDialog.kt  # Custom network form
```

### Files to Modify

- `MetaMaskToolWindow.kt` - Add NetworkSelectorBar to UI
- `PredefinedNetworks.kt` - Add enabled/disabled network tracking
- `ProjectStorage.kt` - Add enabled networks persistence

---

## Implementation Steps

### Step 1: NetworkManager - State Management

Create `core/network/NetworkManager.kt`:

```kotlin
class NetworkManager private constructor(project: Project) {
    private val storage = ProjectStorage.getInstance(project)

    // StateFlow for reactive UI updates
    private val _selectedNetwork = MutableStateFlow<Network>(getInitialNetwork())
    val selectedNetwork: StateFlow<Network> = _selectedNetwork.asStateFlow()

    private val _enabledNetworks = MutableStateFlow<List<Network>>(getInitialEnabledNetworks())
    val enabledNetworks: StateFlow<List<Network>> = _enabledNetworks.asStateFlow()

    private val _customNetworks = MutableStateFlow<List<Network>>(storage.getCustomNetworks())
    val customNetworks: StateFlow<List<Network>> = _customNetworks.asStateFlow()

    // Functions: selectNetwork(), addCustomNetwork(), removeCustomNetwork(),
    //            enableNetwork(), disableNetwork(), getAllNetworks()
}
```

**Key behaviors:**
- Default to BNB Testnet on first load
- Persist selected network per project
- Manage enabled/disabled state for predefined networks
- Support custom network CRUD operations

### Step 2: Network Models (No Validation Required)

**No NetworkValidator needed** - Users may use localhost for smart contract development, so we skip RPC validation entirely. Custom networks are saved as-is with user-provided values.

### Step 3: NetworkSelectorBar - UI Component

Create `ui/panels/NetworkSelectorBar.kt`:

```kotlin
class NetworkSelectorBar : JPanel() {
    var onNetworkClick: (() -> Unit)? = null

    // UI: [Network Icon] [Network Name    ▼]
    // Full-width bar with hover effect
    // Shows current network name and testnet indicator

    fun updateNetwork(network: Network)
}
```

**Design:**
- Full-width panel below title
- Left: Network icon/initial (e.g., "B" for BNB)
- Center: Network name (e.g., "BNB Testnet")
- Right: Dropdown arrow indicator
- Testnet badge/indicator for testnet networks
- Clickable to open NetworkSelectionDialog

### Step 4: NetworkSelectionDialog

Create `ui/dialogs/NetworkSelectionDialog.kt`:

```kotlin
class NetworkSelectionDialog(
    project: Project,
    networkManager: NetworkManager
) : DialogWrapper(project) {
    // UI Layout:
    // - Title: "Select a network"
    // - Search field (optional, can add later)
    // - "Enabled networks" section with list
    // - "Additional networks" section with "Add" buttons
    // - "+ Add a custom network" button at bottom
}
```

**Features:**
- List enabled networks (testnets by default: BNB Testnet, Sepolia, Mumbai)
- Show additional predefined networks with "Add" button to enable them
- Highlight currently selected network
- Click network to select and close dialog
- Three-dot menu per network for: Edit (custom only), Remove/Disable

### Step 5: AddCustomNetworkDialog

Create `ui/dialogs/AddCustomNetworkDialog.kt`:

```kotlin
class AddCustomNetworkDialog(
    project: Project,
    networkManager: NetworkManager,
    existingNetwork: Network? = null  // For edit mode
) : DialogWrapper(project) {
    // Form fields:
    // - Network Name (required)
    // - RPC URL (required) - no validation, allows localhost
    // - Chain ID (required, must be positive integer)
    // - Currency Symbol (required)
    // - Block Explorer URL (optional)
    // - Is Testnet checkbox
}
```

**Simple validation:**
- All required fields must be filled
- Chain ID must be positive integer
- No RPC connection validation (allows localhost for development)

### Step 6: Update MetaMaskToolWindow

Modify `ui/MetaMaskToolWindow.kt`:

```kotlin
// Add NetworkManager instance
private val networkManager = NetworkManager.getInstance(project)
private val networkSelectorBar = NetworkSelectorBar()

// In setupUI(), add between title and content:
// titlePanel (North)
// networkSelectorBar (below title)
// contentPanel (Center - wallet list, info, buttons)

// Add network observation in observeWalletChanges():
scope.launch {
    networkManager.selectedNetwork.collect { network ->
        SwingUtilities.invokeLater {
            networkSelectorBar.updateNetwork(network)
        }
    }
}

// Add click handler:
networkSelectorBar.onNetworkClick = {
    showNetworkSelectionDialog()
}
```

### Step 7: Update ProjectStorage

Add to `ProjectStorage.kt`:

```kotlin
// In State class:
var enabledNetworkIds: String = "[\"BNB_TESTNET\", \"ETH_SEPOLIA\", \"POLYGON_TESTNET\"]"

// Methods:
fun getEnabledNetworkIds(): List<String>
fun setEnabledNetworkIds(ids: List<String>)
```

### Step 8: Update PredefinedNetworks

Modify `core/network/PredefinedNetworks.kt`:

```kotlin
// Add helper methods:
fun getDefaultEnabledNetworks(): List<Network>  // Returns testnets only
fun isNetworkEnabled(id: String, enabledIds: List<String>): Boolean
```

---

## UI Flow

```
┌─────────────────────────────────────┐
│         MetaMask Clone              │
├─────────────────────────────────────┤
│  [B] BNB Testnet              ▼     │  ← NetworkSelectorBar (click opens dialog)
├─────────────────────────────────────┤
│  ┌─────────────────────────────┐    │
│  │ Wallets                     │    │
│  │  • Wallet 1                 │    │
│  │  • Wallet 2                 │    │
│  └─────────────────────────────┘    │
│  ┌─────────────────────────────┐    │
│  │ Selected Wallet             │    │
│  │  Name: ...                  │    │
│  │  Address: ...               │    │
│  └─────────────────────────────┘    │
│  [Create] [Import] [Export] [Delete]│
└─────────────────────────────────────┘
```

**Network Selection Dialog:**
```
┌─────────────────────────────────────┐
│     Select a network           ✕    │
├─────────────────────────────────────┤
│  Enabled networks                   │
│  ┌─────────────────────────────┐    │
│  │ [B] BNB Testnet        ✓    │    │  ← Selected (highlighted)
│  │ [E] Ethereum Sepolia        │    │
│  │ [P] Polygon Mumbai          │    │
│  └─────────────────────────────┘    │
│                                     │
│  Additional networks                │
│  ┌─────────────────────────────┐    │
│  │ [B] BNB Smart Chain    Add  │    │
│  │ [E] Ethereum Mainnet   Add  │    │
│  │ [P] Polygon            Add  │    │
│  └─────────────────────────────┘    │
│                                     │
│  ┌─────────────────────────────┐    │
│  │  + Add a custom network     │    │
│  └─────────────────────────────┘    │
└─────────────────────────────────────┘
```

---

# Phase 3: UI Components (No Blockchain Integration)

## Overview

Create UI components for balance display, token management, and transaction sending. These are **UI only** - no actual blockchain calls. Data will be placeholder/mock until blockchain integration.

## New Files for Phase 3 UI

### Models

Create `models/Token.kt`:
```kotlin
@Serializable
data class Token(
    val contractAddress: String,
    val symbol: String,
    val name: String,
    val decimals: Int = 18,
    val balance: String = "0",      // Placeholder
    val networkId: String           // Which network this token belongs to
)
```

### Step 9: BalanceDisplayPanel

Create `ui/panels/BalanceDisplayPanel.kt`:

```kotlin
class BalanceDisplayPanel : JPanel() {
    // UI Layout (like MetaMask main.png):
    // - Large balance text: "0.00 tBNB"
    // - Smaller USD value: "$0.00 (+0.00%)"
    // - "Portfolio" link (optional)

    fun updateBalance(balance: String, symbol: String, usdValue: String?)
}
```

**Design:**
- Large, bold balance display (e.g., "0.398 TBNB")
- Smaller gray text for USD value
- Center-aligned

### Step 10: ActionButtonsRow

Create `ui/panels/ActionButtonsRow.kt`:

```kotlin
class ActionButtonsRow : JPanel() {
    var onSendClick: (() -> Unit)? = null
    var onReceiveClick: (() -> Unit)? = null

    // UI: Row of circular icon buttons (like MetaMask)
    // [Send] [Receive]
    // Each button: icon above, label below
}
```

**Design (simplified from MetaMask):**
- Two action buttons: Send, Receive
- Circular buttons with icons
- Label below each button

### Step 11: TokenListPanel

Create `ui/panels/TokenListPanel.kt`:

```kotlin
class TokenListPanel : JPanel() {
    var onTokenSelected: ((Token) -> Unit)? = null
    var onAddTokenClick: (() -> Unit)? = null

    // UI:
    // - "Tokens" header with network filter dropdown
    // - List of tokens with: icon, symbol, balance
    // - "+ Add Token" button at bottom

    fun updateTokens(tokens: List<Token>)
}
```

**Token row design:**
```
[T]  USDT                    11,012,059.5982 USDT
 B
```
- Left: Token icon/initial with network badge
- Center: Token symbol
- Right: Balance

### Step 12: SendTokenDialog (UI Only)

Create `ui/dialogs/SendTokenDialog.kt`:

```kotlin
class SendTokenDialog(
    project: Project,
    wallet: Wallet,
    token: Token? = null  // null = native token
) : DialogWrapper(project) {
    // Form fields:
    // - To Address (required)
    // - Amount (required)
    // - Token selector dropdown
    // - Gas settings (placeholder, not functional)

    // Buttons: [Cancel] [Send]
    // Send button shows confirmation but doesn't actually send
}
```

### Step 13: ReceiveDialog

Create `ui/dialogs/ReceiveDialog.kt`:

```kotlin
class ReceiveDialog(
    project: Project,
    wallet: Wallet
) : DialogWrapper(project) {
    // UI:
    // - QR code of wallet address (using ZXing)
    // - Wallet address text (copyable)
    // - [Copy Address] button
}
```

### Step 14: AddTokenDialog

Create `ui/dialogs/AddTokenDialog.kt`:

```kotlin
class AddTokenDialog(
    project: Project,
    networkId: String
) : DialogWrapper(project) {
    // Form fields:
    // - Contract Address (required)
    // - Token Symbol (required)
    // - Token Name (optional)
    // - Decimals (default: 18)

    // No validation - just saves the token info
}
```

### Step 15: TabPanel for Tokens/Activity

Create `ui/panels/MainTabPanel.kt`:

```kotlin
class MainTabPanel : JPanel() {
    // Tabbed interface like MetaMask:
    // [Tokens] [Activity]

    // Tokens tab: TokenListPanel
    // Activity tab: Placeholder for Phase 4
}
```

### Step 16: Update MetaMaskToolWindow for Phase 3

Modify main layout to match MetaMask (main.png):

```
┌─────────────────────────────────────┐
│         MetaMask Clone              │
├─────────────────────────────────────┤
│  [B] BNB Testnet              ▼     │  ← NetworkSelectorBar
├─────────────────────────────────────┤
│  Wallet: User           ▼           │  ← WalletSelectorBar (shows current wallet)
│  0xA7FE2...A37C7  [Copy]            │
├─────────────────────────────────────┤
│                                     │
│        0.398 TBNB                   │  ← BalanceDisplayPanel
│          $0.00                      │
│                                     │
├─────────────────────────────────────┤
│      [Send]    [Receive]            │  ← ActionButtonsRow
├─────────────────────────────────────┤
│  [Tokens]  [Activity]               │  ← MainTabPanel
│  ─────────────────────              │
│  BNB Testnet  ▼                     │
│  ┌─────────────────────────────┐    │
│  │ [T] USDT     11,012,059 USDT│    │  ← TokenListPanel
│  │ [N] NPG         900,000 NPG │    │
│  │ [T] tBNB          0.398 tBNB│    │
│  └─────────────────────────────┘    │
│  [+ Add Token]                      │
└─────────────────────────────────────┘
```

---

## File Structure Summary

### Phase 2 Files (Network Management)
```
src/main/kotlin/dev/eastgate/metamaskclone/
├── core/
│   └── network/
│       └── NetworkManager.kt
├── ui/
│   ├── panels/
│   │   └── NetworkSelectorBar.kt
│   └── dialogs/
│       ├── NetworkSelectionDialog.kt
│       └── AddCustomNetworkDialog.kt
```

### Phase 3 Files (UI Only)
```
src/main/kotlin/dev/eastgate/metamaskclone/
├── models/
│   └── Token.kt
├── ui/
│   ├── panels/
│   │   ├── BalanceDisplayPanel.kt
│   │   ├── ActionButtonsRow.kt
│   │   ├── TokenListPanel.kt
│   │   ├── WalletSelectorBar.kt
│   │   └── MainTabPanel.kt
│   └── dialogs/
│       ├── SendTokenDialog.kt
│       ├── ReceiveDialog.kt
│       └── AddTokenDialog.kt
```

---

## Critical Files Summary

### Phase 2 - Create:
- `core/network/NetworkManager.kt`
- `ui/panels/NetworkSelectorBar.kt`
- `ui/dialogs/NetworkSelectionDialog.kt`
- `ui/dialogs/AddCustomNetworkDialog.kt`

### Phase 3 UI - Create:
- `models/Token.kt`
- `ui/panels/BalanceDisplayPanel.kt`
- `ui/panels/ActionButtonsRow.kt`
- `ui/panels/TokenListPanel.kt`
- `ui/panels/WalletSelectorBar.kt`
- `ui/panels/MainTabPanel.kt`
- `ui/dialogs/SendTokenDialog.kt`
- `ui/dialogs/ReceiveDialog.kt`
- `ui/dialogs/AddTokenDialog.kt`

### Modify:
- `ui/MetaMaskToolWindow.kt` - Complete UI redesign to match MetaMask layout
- `core/storage/ProjectStorage.kt` - Add enabledNetworkIds, tokens storage
- `core/network/PredefinedNetworks.kt` - Add helper methods

---

## Implementation Order (Combined)

1. **NetworkManager** - Core network state management
2. **ProjectStorage updates** - Enabled networks + tokens persistence
3. **NetworkSelectorBar** - Network selector UI
4. **NetworkSelectionDialog** - Network list dialog
5. **AddCustomNetworkDialog** - Custom network form
6. **Token model** - Token data class
7. **WalletSelectorBar** - Wallet dropdown (replaces old wallet list)
8. **BalanceDisplayPanel** - Balance display
9. **ActionButtonsRow** - Send/Receive buttons
10. **TokenListPanel** - Token list
11. **MainTabPanel** - Tokens/Activity tabs
12. **SendTokenDialog** - Send form (UI only)
13. **ReceiveDialog** - QR code display
14. **AddTokenDialog** - Add token form
15. **MetaMaskToolWindow redesign** - Integrate all components
16. **Testing & Polish**

---

## Technical Considerations

### Threading
- UI updates via SwingUtilities.invokeLater
- StateFlow observations on Main dispatcher

### Default Enabled Networks
```kotlin
val DEFAULT_ENABLED_IDS = listOf("BNB_TESTNET", "ETH_SEPOLIA", "POLYGON_TESTNET")
```

---

## Success Criteria

### Phase 2 - Network Management
- [x] Network selector bar visible below title
- [x] Click bar opens network selection dialog
- [x] Can switch between enabled networks
- [x] Can enable/disable predefined networks
- [x] Can add custom network (no validation, allows localhost)
- [x] Can edit/remove custom networks
- [x] Selected network persists across IDE restarts
- [x] BNB Testnet is default on fresh install
- [x] Only testnets enabled by default

### Phase 3 - UI Components (No Blockchain)
- [x] Wallet selector bar shows current wallet with dropdown
- [x] Balance display panel shows placeholder balance
- [x] Send/Receive action buttons visible
- [x] Token list displays added tokens (placeholder balances)
- [x] Can add custom tokens
- [x] Send dialog opens with form (doesn't actually send)
- [x] Receive dialog shows QR code of address
- [x] Tokens/Activity tab navigation works
- [x] UI matches MetaMask reference design
