# Plan: EVM & TRON Transaction History Activity Panel

**Status: COMPLETE**

## Context

The Activity tab currently shows "No activity yet" placeholder for EVM and TRON networks (Bitcoin already has `BitcoinActivityPanel`). We need to implement a UI that displays combined native + token transaction history, sorted by datetime descending.

- **EVM**: Combine `getNativeTransactions()` + `getErc20Transactions()` from `EvmScanClient`
- **TRON**: Combine `getTrxTransactions()` + `getTrc20Transactions()` from `TronGridClient`

## Files to Modify/Create

| # | File | Action | Purpose |
|---|------|--------|---------|
| 1 | `ui/panels/ActivityPanel.kt` | **Create** | Reusable activity panel for EVM & TRON |
| 2 | `core/blockchain/EvmScanClient.kt` | Modify | Make `tokenAddress` optional in `getErc20Transactions()` |
| 3 | `core/blockchain/TronGridClient.kt` | Modify | Add Nile testnet support |
| 4 | `core/blockchain/BlockchainService.kt` | Modify | Add `getEvmTransactions()` + `getTronTransactions()` methods |
| 5 | `ui/panels/MainTabPanel.kt` | Modify | Add `replaceActivityPanel()` method |
| 6 | `ui/MetaMaskToolWindow.kt` | Modify | Wire activity panel, load transactions on network/wallet change |

All paths relative to `src/main/kotlin/dev/eastgate/metamaskclone/`

## Step 1: Create ActivityPanel with ActivityItem

**File:** `ui/panels/ActivityPanel.kt`

A single reusable panel for both EVM and TRON (rows are identical: direction, address, amount, date). Follows `BitcoinActivityPanel` pattern.

**Display model** — simple data class to decouple from chain-specific models:
```kotlin
data class ActivityItem(
    val txHash: String,              // For click handler / details
    val direction: String,           // "Sent" or "Received"
    val counterpartyAddress: String,
    val amount: String,              // Formatted amount string e.g. "0.1"
    val symbol: String,              // e.g. "ETH", "TRX", "MUSDC", "EGT"
    val timestamp: Long,             // Unix seconds for display
    val isSend: Boolean,             // For color coding (red=send, green=receive)
    val explorerUrl: String?         // For opening in browser on click
)
```

**Panel design:**
- Header: "Transaction History" title + Refresh button
- Scrollable list using `BoxLayout.Y_AXIS` in `JBScrollPane`
- States: loading, error, empty, populated
- Each row:
  - **Left**: Direction label ("Sent" / "Received" — green/red), counterparty address (shortened)
  - **Right**: Amount with symbol (e.g., "+0.1 TRX", "-1.2 EGT"), date formatted

**Callbacks:**
- `var onRefreshClick: (() -> Unit)?`
- `var onTransactionClick: ((ActivityItem) -> Unit)?`

**Methods:**
- `fun updateTransactions(transactions: List<ActivityItem>)` — renders list
- `fun showLoading()` — loading state
- `fun showError(message: String)` — error state

**Mapping extension functions** (in same file):

`EvmTransaction.toActivityItem(walletAddress, network)`:
- `isSend` = `from.equals(walletAddress, ignoreCase = true)`
- `counterpartyAddress` = if send → `to`, else → `from`
- `amount` = `displayValue.toPlainString()`
- `symbol` = if ERC20 → `tokenSymbol`, else → `network.symbol`
- `timestamp` = `timeStamp` (already seconds)
- `explorerUrl` = `"${network.blockExplorerUrl}/tx/$hash"`

`TronTransaction.toActivityItem(walletAddress, network)`:
- `isSend` = `ownerAddress == walletAddress`
- `counterpartyAddress` = if send → `toAddress`, else → `ownerAddress`
- `amount` = if TRX → `amountInTrx?.toPlainString()`, else → `displayValue?.toPlainString()`
- `symbol` = if TRC20 → `tokenSymbol ?: ""`, else → `network.symbol`
- `timestamp` = `blockTimestamp / 1000` (convert ms to seconds)
- `explorerUrl` = `"${network.blockExplorerUrl}/#/transaction/$txID"`

## Step 2: Make tokenAddress Optional in EvmScanClient

**File:** `core/blockchain/EvmScanClient.kt`

Change `getErc20Transactions()` signature:
```kotlin
fun getErc20Transactions(
    chainId: Long,
    walletAddress: String,
    tokenAddress: String? = null,  // Was required, now optional
    ...
)
```

When `tokenAddress` is null, omit `&contractaddress` from the URL. Etherscan V2 API supports this — returns ALL ERC20 transfers for the wallet.

## Step 3: Add Nile Testnet Support to TronGridClient

**File:** `core/blockchain/TronGridClient.kt`

Add Nile testnet URL and factory method:
```kotlin
companion object {
    private const val SHASTA_URL = "https://api.shasta.trongrid.io"
    private const val MAINNET_URL = "https://api.trongrid.io"
    private const val NILE_URL = "https://nile.trongrid.io"

    fun ofShasta() = TronGridClient(SHASTA_URL)
    fun ofMainnet() = TronGridClient(MAINNET_URL)
    fun ofNile() = TronGridClient(NILE_URL)
}
```

## Step 4: Add Service Methods to BlockchainService

**File:** `core/blockchain/BlockchainService.kt`

**New client caches:**
```kotlin
private val evmScanClients = ConcurrentHashMap<String, EvmScanClient>()
private val tronGridClients = ConcurrentHashMap<String, TronGridClient>()
```

**New method `getEvmTransactions()`:**
1. Get or create `EvmScanClient` with hardcoded API key (TODO: make configurable later)
2. Call `getNativeTransactions(network.chainId, walletAddress, offset=20)`
3. For each token in `tokens` where `token.networkId == network.id`, call `getErc20Transactions(network.chainId, walletAddress, token.contractAddress, offset=20)`
4. Combine all results, sort by `timeStamp` descending
5. Return wrapped in sealed result class

**New method `getTronTransactions()`:**
1. Get or create `TronGridClient` based on `network.id`:
   - `TRON_MAINNET` → `TronGridClient.ofMainnet()`
   - `TRON_SHASTA` → `TronGridClient.ofShasta()`
   - `TRON_NILE` → `TronGridClient.ofNile()`
2. Call `getTrxTransactions(walletAddress)` + `getTrc20Transactions(walletAddress)`
3. Combine, sort by `blockTimestamp` descending
4. Return wrapped in sealed result class

**New sealed result classes:**
```kotlin
sealed class EvmTransactionsResult {
    data class Success(val transactions: List<EvmTransaction>) : EvmTransactionsResult()
    data class Error(val message: String) : EvmTransactionsResult()
}

sealed class TronTransactionsResult {
    data class Success(val transactions: List<TronTransaction>) : TronTransactionsResult()
    data class Error(val message: String) : TronTransactionsResult()
}
```

**Cleanup:** Add `evmScanClients` and `tronGridClients` to `invalidateNetwork()` and `shutdown()`.

## Step 5: Update MainTabPanel

**File:** `ui/panels/MainTabPanel.kt`

Add method to swap Activity panel for EVM/TRON (same pattern as `replacePlaceholderWithBitcoin()`):
```kotlin
fun replaceActivityPanel(panel: JPanel) {
    contentPanel.remove(/* current activity component */)
    contentPanel.add(panel, "Activity")
    if (selectedTab == "Activity") {
        val cardLayout = contentPanel.layout as CardLayout
        cardLayout.show(contentPanel, "Activity")
    }
    contentPanel.revalidate()
    contentPanel.repaint()
}
```

## Step 6: Wire ActivityPanel in MetaMaskToolWindow

**File:** `ui/MetaMaskToolWindow.kt`

**New field:**
```kotlin
private val activityPanel = ActivityPanel()
```

**Update `showStandardUI()`** — instead of restoring placeholder, swap in the activityPanel:
```kotlin
private fun showStandardUI() {
    // ... existing code to restore header ...
    mainTabPanel.replaceActivityPanel(activityPanel)
    mainTabPanel.showTokenAddButton()
    mainTabPanel.showStandardTabs()
    // Wire up event handlers
    activityPanel.onRefreshClick = { loadActivityTransactions() }
    activityPanel.onTransactionClick = { item -> showTransactionDetails(item) }
    // Load transactions
    loadActivityTransactions()
}
```

**New method `loadActivityTransactions()`:**
```kotlin
private fun loadActivityTransactions() {
    val wallet = walletManager.selectedWallet.value ?: return
    val network = networkManager.selectedNetwork.value
    if (network.blockchainType == BlockchainType.BITCOIN) return
    activityPanel.showLoading()

    scope.launch {
        when (network.blockchainType) {
            BlockchainType.EVM -> {
                val networkTokens = tokens.filter { it.networkId == network.id }
                val result = blockchainService.getEvmTransactions(network, wallet.address, networkTokens)
                SwingUtilities.invokeLater {
                    when (result) {
                        is EvmTransactionsResult.Success -> {
                            val items = result.transactions.map { it.toActivityItem(wallet.address, network) }
                            activityPanel.updateTransactions(items)
                        }
                        is EvmTransactionsResult.Error -> activityPanel.showError(result.message)
                    }
                }
            }
            BlockchainType.TRON -> {
                val result = blockchainService.getTronTransactions(network, wallet.address)
                SwingUtilities.invokeLater {
                    when (result) {
                        is TronTransactionsResult.Success -> {
                            val items = result.transactions.map { it.toActivityItem(wallet.address, network) }
                            activityPanel.updateTransactions(items)
                        }
                        is TronTransactionsResult.Error -> activityPanel.showError(result.message)
                    }
                }
            }
            BlockchainType.BITCOIN -> { /* handled by BitcoinActivityPanel */ }
        }
    }
}
```

**Update `observeChanges()`** — refresh activity when network/wallet changes:
- In `networkManager.selectedNetwork.collect`: call `loadActivityTransactions()` for non-Bitcoin
- In `walletManager.selectedWallet.collect`: call `loadActivityTransactions()` for non-Bitcoin

## TronGrid API URLs

| Network | API Base URL |
|---------|-------------|
| Mainnet | `https://api.trongrid.io` |
| Shasta | `https://api.shasta.trongrid.io` |
| Nile | `https://nile.trongrid.io` |

## Implementation Order

1. Create `ActivityPanel.kt` with `ActivityItem` data class + mapping extensions
2. Make `tokenAddress` optional in `EvmScanClient.getErc20Transactions()`
3. Add Nile testnet support to `TronGridClient`
4. Add service methods + sealed results to `BlockchainService.kt`
5. Update `MainTabPanel.kt` with `replaceActivityPanel()`
6. Wire everything in `MetaMaskToolWindow.kt`

## Verification

- `./gradlew build` — compile and run all existing tests
- Run IDE (`./gradlew runIde`):
  - Select EVM network (Sepolia) → Activity tab shows combined native + ERC20 transactions
  - Select TRON network (Shasta) → Activity tab shows combined TRX + TRC20 transactions
  - Switch wallets → Activity refreshes
  - Click Refresh → reloads transactions
  - Click transaction row → shows details dialog
  - Switch to Bitcoin → Bitcoin activity panel still works as before
