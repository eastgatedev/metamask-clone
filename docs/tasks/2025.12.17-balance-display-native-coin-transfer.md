# Implementation Plan: Balance Display & Native Coin Transfer

**Date:** 2025-12-17
**Status:** ✅ COMPLETED

## Overview

Add real blockchain balance fetching and native coin transfer functionality to the MetaMask Clone IntelliJ plugin UI.

---

## Files to Create

### 1. BlockchainService.kt (NEW)

**Path:** `src/main/kotlin/dev/eastgate/metamaskclone/core/blockchain/BlockchainService.kt`

A new service class encapsulating all Web3j blockchain operations:

**Methods:**
- `getBalance(address: String, network: Network): BalanceResult` - Fetch native coin balance
- `getGasPrice(network: Network): GasPriceResult` - Get current gas price
- `getNonce(address: String, network: Network): NonceResult` - Get transaction count
- `sendNativeCoin(from, to, amount, privateKey, network, gasLimit?, gasPrice?): TransactionResult` - Send transaction
- `waitForConfirmation(txHash, network, maxWaitSeconds): ConfirmationResult` - Poll for transaction receipt

**Sealed Result Classes:**
```kotlin
sealed class BalanceResult {
    data class Success(val balanceWei: BigInteger, val balanceFormatted: String, val symbol: String)
    data class Error(val message: String)
}

sealed class GasPriceResult {
    data class Success(val gasPrice: BigInteger)
    data class Error(val message: String)
}

sealed class TransactionResult {
    data class Success(val transactionHash: String, val explorerUrl: String?)
    data class Error(val message: String)
}

sealed class ConfirmationResult {
    data class Confirmed(val blockNumber: BigInteger, val gasUsed: BigInteger, val success: Boolean)
    object Timeout
    data class Error(val message: String)
}
```

**Design Pattern:**
- Singleton per project using `getInstance(project)` with `ConcurrentHashMap`
- Cache Web3j instances per network ID to avoid reconnection overhead
- All blockchain calls use `withContext(Dispatchers.IO)` for non-blocking execution

---

## Files to Modify

### 2. BalanceDisplayPanel.kt

**Path:** `src/main/kotlin/dev/eastgate/metamaskclone/ui/panels/BalanceDisplayPanel.kt`

**Changes:**
1. Add loading state display:
   ```kotlin
   fun showLoading() {
       balanceLabel.text = "..."
       usdValueLabel.text = "Loading balance..."
       usdValueLabel.foreground = JBColor.gray
   }
   ```

2. Add error state display:
   ```kotlin
   fun showError(message: String) {
       balanceLabel.text = "Error"
       usdValueLabel.text = message
       usdValueLabel.foreground = JBColor.RED
   }
   ```

3. Add refresh button with callback:
   ```kotlin
   private val refreshButton = JButton("↻")
   var onRefreshClick: (() -> Unit)? = null
   ```

4. Reset foreground color in `updateBalance()` to handle transition from error state

---

### 3. MetaMaskToolWindow.kt

**Path:** `src/main/kotlin/dev/eastgate/metamaskclone/ui/MetaMaskToolWindow.kt`

**Changes:**

1. Add BlockchainService member:
   ```kotlin
   private val blockchainService = BlockchainService.getInstance(project)
   ```

2. Replace placeholder `updateBalanceDisplay()` (line 170-174) with real implementation:
   ```kotlin
   private fun updateBalanceDisplay() {
       val wallet = walletManager.selectedWallet.value
       val network = networkManager.selectedNetwork.value

       if (wallet == null) {
           balanceDisplayPanel.updateBalance("0", network.symbol, null)
           return
       }

       balanceDisplayPanel.showLoading()

       scope.launch {
           when (val result = blockchainService.getBalance(wallet.address, network)) {
               is BalanceResult.Success -> SwingUtilities.invokeLater {
                   balanceDisplayPanel.updateBalance(result.balanceFormatted, result.symbol, null)
               }
               is BalanceResult.Error -> SwingUtilities.invokeLater {
                   balanceDisplayPanel.showError(result.message)
               }
           }
       }
   }
   ```

3. Update `showSendDialog()` (line 269-281) to pass required dependencies:
   ```kotlin
   private fun showSendDialog() {
       val wallet = walletManager.selectedWallet.value
       if (wallet == null) {
           Messages.showWarningDialog(project, "Please select a wallet first", "No Wallet Selected")
           return
       }

       val network = networkManager.selectedNetwork.value
       val networkTokens = tokens.filter { it.networkId == network.id }

       val dialog = SendTokenDialog(
           project = project,
           wallet = wallet,
           network = network,
           walletManager = walletManager,
           blockchainService = blockchainService,
           token = null,
           availableTokens = networkTokens
       )

       if (dialog.showAndGet()) {
           updateBalanceDisplay() // Refresh balance after successful send
       }
   }
   ```

4. Wire up refresh button in `setupEventListeners()`:
   ```kotlin
   balanceDisplayPanel.onRefreshClick = {
       updateBalanceDisplay()
   }
   ```

5. Add cleanup in `dispose()` (line 378-380):
   ```kotlin
   fun dispose() {
       scope.cancel()
       blockchainService.shutdown()
   }
   ```

---

### 4. SendTokenDialog.kt

**Path:** `src/main/kotlin/dev/eastgate/metamaskclone/ui/dialogs/SendTokenDialog.kt`

**Major Changes:**

1. Update constructor to accept new dependencies:
   ```kotlin
   class SendTokenDialog(
       private val project: Project,
       private val wallet: Wallet,
       private val network: Network,
       private val walletManager: WalletManager,
       private val blockchainService: BlockchainService,
       private val token: Token? = null,
       private val availableTokens: List<Token> = emptyList()
   ) : DialogWrapper(project)
   ```

2. Add coroutine scope:
   ```kotlin
   private val scope = CoroutineScope(Dispatchers.Main + SupervisorJob())
   ```

3. Enable gas fields and fetch gas price on dialog open:
   ```kotlin
   private fun fetchGasPrice() {
       scope.launch {
           when (val result = blockchainService.getGasPrice(network)) {
               is GasPriceResult.Success -> SwingUtilities.invokeLater {
                   val gasPriceGwei = Convert.fromWei(BigDecimal(result.gasPrice), Convert.Unit.GWEI)
                   gasPriceField.text = gasPriceGwei.setScale(2, RoundingMode.CEILING).toPlainString()
                   gasPriceField.isEnabled = true
                   gasLimitField.isEnabled = true
               }
               is GasPriceResult.Error -> SwingUtilities.invokeLater {
                   gasPriceField.text = "5" // Default fallback
                   gasPriceField.isEnabled = true
                   gasLimitField.isEnabled = true
               }
           }
       }
   }
   ```

4. Implement real transaction sending in `doOKAction()`:
   ```kotlin
   override fun doOKAction() {
       // ... existing validation ...

       // Only support native token for now
       if (tokenSelector.selectedIndex != 0) {
           Messages.showWarningDialog(project, "ERC-20 token transfers coming soon", "Not Implemented")
           return
       }

       // Request password for private key
       val password = Messages.showPasswordDialog(
           "Enter wallet password to sign transaction:",
           "Sign Transaction"
       )
       if (password == null) return

       // Get private key
       val privateKey: String
       try {
           privateKey = walletManager.exportPrivateKey(wallet.address, password)
       } catch (e: Exception) {
           Messages.showErrorDialog(project, "Invalid password: ${e.message}", "Error")
           return
       }

       // Disable dialog while sending
       isOKActionEnabled = false
       setCursor(Cursor.getPredefinedCursor(Cursor.WAIT_CURSOR))

       scope.launch {
           val gasPrice = Convert.toWei(BigDecimal(gasPriceField.text), Convert.Unit.GWEI).toBigInteger()
           val gasLimit = BigInteger(gasLimitField.text)

           val result = blockchainService.sendNativeCoin(
               fromAddress = wallet.address,
               toAddress = toAddress,
               amount = amountValue,
               privateKey = privateKey,
               network = network,
               gasLimit = gasLimit,
               gasPrice = gasPrice
           )

           SwingUtilities.invokeLater {
               setCursor(Cursor.getDefaultCursor())
               isOKActionEnabled = true

               when (result) {
                   is TransactionResult.Success -> {
                       val message = buildString {
                           append("Transaction sent successfully!\n\n")
                           append("Transaction Hash:\n${result.transactionHash}\n\n")
                           result.explorerUrl?.let { append("View on Explorer:\n$it") }
                       }
                       Messages.showInfoMessage(project, message, "Transaction Sent")
                       ClipboardUtil.copyToClipboard(result.transactionHash)
                       super.doOKAction()
                   }
                   is TransactionResult.Error -> {
                       Messages.showErrorDialog(project, "Transaction failed: ${result.message}", "Error")
                   }
               }
           }
       }
   }
   ```

5. Add cleanup:
   ```kotlin
   override fun dispose() {
       scope.cancel()
       super.dispose()
   }
   ```

6. Update UI to remove placeholder warnings (lines 117-119, 131, 143, 151-152)

---

## Implementation Steps

### Step 1: Create BlockchainService
1. Create new directory: `src/main/kotlin/dev/eastgate/metamaskclone/core/blockchain/`
2. Create `BlockchainService.kt` with all methods and result classes
3. Test against BNB Testnet using patterns from `TestWeb3j.kt`

### Step 2: Update BalanceDisplayPanel
1. Add `showLoading()` method
2. Add `showError(message)` method
3. Add refresh button with `onRefreshClick` callback
4. Ensure `updateBalance()` resets foreground color

### Step 3: Update MetaMaskToolWindow
1. Add `blockchainService` member
2. Implement real `updateBalanceDisplay()` with coroutine
3. Wire up refresh button callback
4. Update `showSendDialog()` to pass dependencies
5. Add shutdown in `dispose()`

### Step 4: Update SendTokenDialog
1. Update constructor with new parameters
2. Add `CoroutineScope`
3. Implement `fetchGasPrice()` and call in `init`
4. Implement real `doOKAction()` with transaction sending
5. Remove placeholder UI elements
6. Add `dispose()` override

### Step 5: Integration Testing
1. Create/import wallet on BNB Testnet
2. Verify balance displays correctly
3. Test refresh button
4. Send small amount (0.00001 BNB) to test address
5. Verify tx hash and explorer link display
6. Test error cases: invalid password, insufficient funds, network errors

---

## Reference Files

- **Web3j patterns:** `src/test/kotlin/dev/eastgate/metamaskclone/TestWeb3j.kt`
- **Network config:** `src/main/kotlin/dev/eastgate/metamaskclone/core/network/PredefinedNetworks.kt`
- **Wallet export:** `src/main/kotlin/dev/eastgate/metamaskclone/core/wallet/WalletManager.kt`

---

## Security Considerations

1. Private key only decrypted when needed for signing
2. Always require password before signing transactions
3. No logging of private keys
4. Clear sensitive data from memory after use