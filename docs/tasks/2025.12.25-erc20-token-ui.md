# ERC20 Token UI Implementation Plan

**Date:** 2025-12-25
**Status:** Complete

## Overview

Add full ERC20 token support to the MetaMask Clone IntelliJ Plugin:
1. Import ERC20 token with auto-fetch metadata from contract
2. Get and display ERC20 balances
3. Send ERC20 tokens

---

## Files to Modify

| File | Changes |
|------|---------|
| `src/main/kotlin/dev/eastgate/metamaskclone/core/blockchain/BlockchainService.kt` | Add ERC20 methods |
| `src/main/kotlin/dev/eastgate/metamaskclone/ui/dialogs/AddTokenDialog.kt` | Add auto-fetch UI |
| `src/main/kotlin/dev/eastgate/metamaskclone/ui/dialogs/SendTokenDialog.kt` | Enable ERC20 transfers |
| `src/main/kotlin/dev/eastgate/metamaskclone/ui/MetaMaskToolWindow.kt` | Add balance refresh logic |

---

## Step 1: Add ERC20 Methods to BlockchainService

**File:** `src/main/kotlin/dev/eastgate/metamaskclone/core/blockchain/BlockchainService.kt`

### Add Sealed Result Classes

```kotlin
sealed class TokenMetadataResult {
    data class Success(val symbol: String, val name: String, val decimals: Int) : TokenMetadataResult()
    data class Error(val message: String) : TokenMetadataResult()
}

sealed class TokenBalanceResult {
    data class Success(val balanceRaw: BigInteger, val balanceFormatted: String) : TokenBalanceResult()
    data class Error(val message: String) : TokenBalanceResult()
}

sealed class TokenTransferResult {
    data class Success(val transactionHash: String, val explorerUrl: String?) : TokenTransferResult()
    data class Error(val message: String) : TokenTransferResult()
}
```

### Add Methods (Using Web3j ERC20 Class)

1. **`getTokenMetadata(contractAddress, network)`**
   ```kotlin
   val erc20 = ERC20.load(contractAddress, web3j, credentials, DefaultGasProvider())
   val symbol = erc20.symbol().send()
   val name = erc20.name().send()
   val decimals = erc20.decimals().send().toInt()
   ```

2. **`getTokenBalance(contractAddress, walletAddress, decimals, network)`**
   ```kotlin
   val erc20 = ERC20.load(contractAddress, web3j, credentials, DefaultGasProvider())
   val balance = erc20.balanceOf(walletAddress).send()
   // Format with decimals
   ```

3. **`sendToken(contractAddress, fromAddress, toAddress, amount, decimals, privateKey, network, gasLimit, gasPrice)`**
   ```kotlin
   val gasProvider = StaticGasProvider(gasPrice, gasLimit)
   val erc20 = ERC20.load(contractAddress, web3j, credentials, gasProvider)
   val receipt = erc20.transfer(toAddress, amountInSmallestUnit).send()
   ```

### Reference Pattern (from TestWeb3j.kt)

```kotlin
val credentials = Credentials.create(privateKey)
val gasProvider = StaticGasProvider(gasPrice, gasLimit)
val erc20 = ERC20.load(EGT_TOKEN_ADDRESS, web3j, credentials, gasProvider)
val receipt = erc20.transfer(recipientAddress, amountToSend).send()
```

**Note:** Use ERC20 class for simplicity. Fall back to low-level ABI encoding only for non-standard tokens.

---

## Step 2: Enhance AddTokenDialog with Auto-Fetch

**File:** `src/main/kotlin/dev/eastgate/metamaskclone/ui/dialogs/AddTokenDialog.kt`

### Changes

1. Update constructor to accept `Network` and `BlockchainService`
2. Add "Fetch" button next to contract address field
3. Add status label for feedback
4. Remove the Phase 3 note (line 106)

### UI Flow

```
[Contract Address: _______________] [Fetch]
[Symbol: ___________] (auto-filled)
[Name: _____________] (auto-filled)
[Decimals: _________] (auto-filled)
[Status: Token info loaded / Error message]
```

### Logic

- On "Fetch" click:
  - Validate address format
  - Call `blockchainService.getTokenMetadata()`
  - Auto-populate symbol, name, decimals fields
  - Show error if fetch fails

---

## Step 3: Add Balance Refresh to MetaMaskToolWindow

**File:** `src/main/kotlin/dev/eastgate/metamaskclone/ui/MetaMaskToolWindow.kt`

### Add Method

```kotlin
private fun refreshTokenBalances() {
    val wallet = walletManager.selectedWallet.value ?: return
    val network = networkManager.selectedNetwork.value
    val networkTokens = tokens.filter { it.networkId == network.id }

    scope.launch {
        for (token in networkTokens) {
            val result = blockchainService.getTokenBalance(
                token.contractAddress, wallet.address, token.decimals, network
            )
            when (result) {
                is TokenBalanceResult.Success -> {
                    // Update token balance in list
                    updateTokenInList(token.id, result.balanceFormatted)
                }
                is TokenBalanceResult.Error -> { /* Log error */ }
            }
        }
        // Save and refresh UI
        SwingUtilities.invokeLater {
            storage.saveTokens(tokens)
            updateTokensUI()
        }
    }
}
```

### Trigger Points

- **Plugin/Tool window loads** - Fetch current balances on startup
- Network changes
- Wallet changes
- After adding new token
- **After sending tokens (native or ERC20)** - Update sender's balance
- Manual refresh button

### Update showAddTokenDialog()

- Pass `Network` and `BlockchainService` to dialog
- After adding token, call `refreshTokenBalances()`

---

## Step 4: Enable ERC20 Transfers in SendTokenDialog

**File:** `src/main/kotlin/dev/eastgate/metamaskclone/ui/dialogs/SendTokenDialog.kt`

### Changes

1. **Remove "coming soon" block (lines 377-381)**

2. **Add token transfer logic**
   ```kotlin
   private fun proceedWithTransaction(...) {
       if (tokenSelector.selectedIndex == 0) {
           // Native token - existing sendNativeCoin logic
           sendNativeToken(...)
       } else {
           // ERC20 token
           val selectedToken = availableTokens[tokenSelector.selectedIndex - 1]
           sendERC20Token(selectedToken, ...)
       }
   }

   private fun sendERC20Token(token, toAddress, amount, gasLimit, gasPrice, privateKey) {
       scope.launch {
           val result = blockchainService.sendToken(
               token.contractAddress, wallet.address, toAddress,
               amount, token.decimals, privateKey, network, gasLimit, gasPrice
           )
           // Handle result...
       }
   }
   ```

3. **Update gas limit default for ERC20**
   - Native: 21000
   - ERC20: 100000

4. **Update balance display when token selected**
   - Native: Use existing `getBalance()`
   - ERC20: Use `getTokenBalance()`

---

## Implementation Order

1. **BlockchainService** - Add all ERC20 methods first (core dependency)
2. **AddTokenDialog** - Auto-fetch metadata UI
3. **MetaMaskToolWindow** - Balance refresh logic
4. **SendTokenDialog** - Enable ERC20 transfers

---

## Testing

After implementation, test with the existing EGT token on BSC Testnet:
- Contract: `0xCef67Ec450a1e1806e097bc50BB81a4005dd46C3`
- Symbol: EGT
- Decimals: 18

### Test Cases

- [x] Import token auto-fetches metadata (symbol, name, decimals)
- [x] Token balance displays correctly in TokenListPanel
- [x] **Token balance refreshes on plugin/tool window load**
- [x] Token balance updates when wallet/network changes
- [x] ERC20 token transfer succeeds
- [x] **Token balance updates after transfer completes**
- [x] Gas limit auto-updates when selecting ERC20 token (21000 â†’ 100000)
- [x] Error handling for invalid contract addresses
- [x] Delete token via right-click context menu
- [x] Delete token via token details dialog