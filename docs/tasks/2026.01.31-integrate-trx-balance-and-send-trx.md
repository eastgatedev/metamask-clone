# Task: Integrate TRX Balance & Send into UI (EP07)

**Date:** 2026-01-31
**Status:** ✅ Complete
**Episode:** EP07 - TRON Runtime: TRX Transfer

---

## Objective

Integrate `TronGrpcClient` into `BlockchainService` and UI to enable:
- TRX balance display in the main wallet panel
- TRX transfer via SendTokenDialog
- Proper handling of TRON-specific behavior (no gas, bandwidth-based)

**Note:** `TronGrpcClient` already exists. This task focuses on UI integration.

---

## Key Design Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Client Management | Cache instances (like Web3j) | gRPC channels are expensive to create |
| Network Config | Use existing factory methods (`ofShasta()`, `ofMainnet()`) | TRON networks already defined, no model changes needed |
| Error Handling | Wrap exceptions → sealed Result classes | Consistent with existing patterns |
| Type Conversion | BigDecimal (TRX) ↔ BigInteger (SUN) at service boundary | Internal consistency |
| Gas UI for TRON | Hide gas fields, show bandwidth info | TRON doesn't use gas |

---

## Files to Modify

### 1. `core/blockchain/BlockchainService.kt` - TRON integration

**Add TronGrpcClient caching with hardcoded endpoint mapping:**
```kotlin
private val tronClients = ConcurrentHashMap<String, TronGrpcClient>()

private fun getTronClient(network: Network): TronGrpcClient {
    return tronClients.computeIfAbsent(network.id) {
        // Map network ID to gRPC client (predefined TRON networks only)
        when (network.id) {
            "TRON_MAINNET" -> TronGrpcClient.ofMainnet()
            "TRON_SHASTA" -> TronGrpcClient.ofShasta()
            else -> throw IllegalStateException("Unknown TRON network: ${network.id}")
        }
    }
}
```

**Update `getBalance()` for TRON:**
```kotlin
if (network.blockchainType == BlockchainType.TRON) {
    return@withContext try {
        val client = getTronClient(network)
        val balanceTrx = client.getBalance(address)
        val balanceSun = balanceTrx.multiply(BigDecimal(TronGrpcClient.SUN_PER_TRX)).toBigInteger()
        BalanceResult.Success(balanceSun, balanceTrx.toPlainString(), network.symbol)
    } catch (e: Exception) {
        BalanceResult.Error(e.message ?: "Failed to fetch TRX balance")
    }
}
```

**Add `sendTronNativeCoin()` method:**
```kotlin
suspend fun sendTronNativeCoin(
    fromAddress: String,
    toAddress: String,
    amount: BigDecimal,
    privateKey: String,
    network: Network
): TransactionResult = withContext(Dispatchers.IO) {
    try {
        // Validate TRON addresses
        if (!isValidTronAddress(fromAddress) || !isValidTronAddress(toAddress)) {
            return@withContext TransactionResult.Error("Invalid TRON address format")
        }

        val client = getTronClient(network)
        val txId = client.sendTrx(fromAddress, toAddress, privateKey, amount)
        val explorerUrl = network.blockExplorerUrl?.let { "$it/#/transaction/$txId" }

        TransactionResult.Success(txId, explorerUrl)
    } catch (e: Exception) {
        TransactionResult.Error(e.message ?: "TRX transfer failed")
    }
}

private fun isValidTronAddress(address: String): Boolean {
    return address.startsWith("T") && address.length == 34
}
```

**Update `sendNativeCoin()` to delegate:**
```kotlin
suspend fun sendNativeCoin(...): TransactionResult = withContext(Dispatchers.IO) {
    if (network.blockchainType == BlockchainType.TRON) {
        return@withContext sendTronNativeCoin(fromAddress, toAddress, amount, privateKey, network)
    }
    // ... existing EVM logic ...
}
```

**Add cleanup methods:**
```kotlin
fun invalidateNetwork(networkId: String) {
    web3jInstances.remove(networkId)?.shutdown()
    tronClients.remove(networkId)?.close()
}

fun shutdown() {
    web3jInstances.values.forEach { it.shutdown() }
    web3jInstances.clear()
    tronClients.values.forEach { it.close() }
    tronClients.clear()
}
```

### 2. `ui/dialogs/SendTokenDialog.kt` - TRON UI adaptation

**Hide gas fields for TRON:**
```kotlin
private fun setupForBlockchainType() {
    val isTron = network.blockchainType == BlockchainType.TRON

    // Hide gas fields for TRON
    gasLimitField.isVisible = !isTron
    gasPriceField.isVisible = !isTron
    gasLabel.isVisible = !isTron

    if (isTron) {
        // Show bandwidth info instead
        setupTronFeeDisplay()
    } else {
        fetchGasPrice()
    }
}

private fun setupTronFeeDisplay() {
    feeLabel.text = "Est. Cost:"
    feeValueLabel.text = "Free (uses bandwidth)"
    feeValueLabel.foreground = JBColor.GREEN

    // Simplified for EP07 - detailed bandwidth display can be EP08
    totalLabel.text = "Total:"
    updateTronTotal()
}

private fun updateTronTotal() {
    val amount = amountField.text.toBigDecimalOrNull() ?: BigDecimal.ZERO
    totalValueLabel.text = "$amount ${network.symbol}"
}
```

**Update send logic:**
```kotlin
private fun proceedWithNativeTransaction(password: String) {
    // ... existing password/key logic ...

    scope.launch {
        val result = if (network.blockchainType == BlockchainType.TRON) {
            blockchainService.sendTronNativeCoin(
                fromAddress = wallet.address,
                toAddress = recipientField.text.trim(),
                amount = amount,
                privateKey = privateKey,
                network = network
            )
        } else {
            blockchainService.sendNativeCoin(...)
        }

        // ... existing result handling ...
    }
}
```

---

## Implementation Order

1. **BlockchainService** - Add TRON client caching + balance/send methods
2. **SendTokenDialog** - Adapt UI for TRON (hide gas, show bandwidth)
3. **Testing** - Verify on Shasta testnet

*Note: No changes needed to Network model or PredefinedNetworks - TRON networks already exist with `blockchainType = BlockchainType.TRON`. gRPC endpoints are mapped via `TronGrpcClient.ofMainnet()`/`ofShasta()` factory methods.*

---

## TRON-Specific Behavior Notes

| Aspect | TRON Behavior | Implementation |
|--------|---------------|----------------|
| Confirmation Time | ~3 seconds per block | Fast UI feedback |
| Transaction Fee | Uses bandwidth (free daily allowance) | Show "Free" in UI |
| Address Format | T-prefix, 34 chars, Base58Check | Validate before send |
| Balance Unit | 1 TRX = 1,000,000 SUN | Convert at service boundary |
| Explorer URL | `tronscan.org/#/transaction/{txId}` | Note the `#` in path |

---

## Verification Checklist

- [x] `./gradlew build` passes
- [x] Switch to TRON Shasta network → balance displays correctly
- [x] SendTokenDialog shows "Free" fee for TRON (no gas fields)
- [x] Send TRX → transaction succeeds, txId shown
- [x] Explorer link opens correct TronScan URL
- [x] Switch back to EVM network → gas fields reappear

---

## Out of Scope (Future)

- TRC20 token support (EP08)
- Detailed bandwidth/energy display
- Custom TRON network dialog
- Transaction confirmation polling

---

## References

- `TronGrpcClient`: `src/main/kotlin/dev/eastgate/metamaskclone/core/blockchain/TronGrpcClient.kt`
- `BlockchainService`: `src/main/kotlin/dev/eastgate/metamaskclone/core/blockchain/BlockchainService.kt`
- `SendTokenDialog`: `src/main/kotlin/dev/eastgate/metamaskclone/ui/dialogs/SendTokenDialog.kt`
- EP07 Guide: `docs/episodes/ep07-trx_transfer_guide.md`
