# Plan: Bitcoin Core UI Integration

**Status: COMPLETE** (2026-02-08)

## Context

Bitcoin Core RPC support (`BitcoinRpcClient`) is already implemented. This plan adds the UI layer so users can: select Bitcoin networks (mainnet/testnet/regtest), view balance, manage receiving addresses, send BTC, and view transaction history. Bitcoin connects to Bitcoin Core only (not public nodes), so users must provide RPC credentials.

**Key difference from EVM/TRON:** Bitcoin Core manages wallets server-side. The plugin doesn't create/import Bitcoin wallets — it connects to Bitcoin Core and uses its wallet. Bitcoin wallets are multi-address (multiple receiving addresses).

## Files to Modify/Create

| # | File | Action | Purpose |
|---|------|--------|---------|
| 1 | `models/BlockchainType.kt` | Modify | Add `BITCOIN` enum value |
| 2 | `core/network/PredefinedNetworks.kt` | Modify | Add Bitcoin Mainnet/Testnet/Regtest networks |
| 3 | `core/blockchain/BitcoinRpcClient.kt` | Modify | Add `listReceivedByAddress()`, `getAllAddresses()`, `BitcoinAddress` data class |
| 4 | `core/blockchain/BlockchainService.kt` | Modify | Add Bitcoin balance/send/addresses/transactions methods + result classes |
| 5 | `core/wallet/WalletManager.kt` | Modify | Add Bitcoin pseudo-wallet support, block create/import/export for Bitcoin |
| 6 | `ui/panels/BitcoinAddressesPanel.kt` | **Create** | Multi-address panel with generate button |
| 7 | `ui/panels/BitcoinActivityPanel.kt` | **Create** | Transaction history panel |
| 8 | `ui/MetaMaskToolWindow.kt` | Modify | Dynamic UI switching between standard/Bitcoin modes |
| 9 | `ui/panels/MainTabPanel.kt` | Modify | Support replacing Activity tab content |
| 10 | `ui/dialogs/SendTokenDialog.kt` | Modify | Bitcoin send support (no gas, no tokens, auto setTxFee for regtest) |

All paths relative to `src/main/kotlin/dev/eastgate/metamaskclone/`

## Step 1: BlockchainType + PredefinedNetworks

**BlockchainType.kt** — Add `BITCOIN` to enum:
```kotlin
enum class BlockchainType { EVM, TRON, BITCOIN }
```

**PredefinedNetworks.kt** — Add 3 Bitcoin networks with `blockchainType = BlockchainType.BITCOIN`, `chainId = -1`:
- `BTC_MAINNET` — port 8332, symbol "BTC", explorer blockstream.info
- `BTC_TESTNET` — port 18332, symbol "tBTC", isTestnet=true
- `BTC_REGTEST` — port 18443, symbol "BTC", isTestnet=true, no explorer

RPC URLs embed credentials: `http://user:pass@127.0.0.1:port` (BitcoinRpcClient already parses this). Add `BTC_REGTEST` to `DEFAULT_ENABLED_IDS`.

## Step 2: BitcoinRpcClient — Address Listing

Add `BitcoinAddress` data class and two new methods:

- `getAllAddresses(): List<String>` — calls `getaddressesbylabel("")`, falls back to `listreceivedbyaddress`
- `listReceivedByAddress(minConf: Int = 0): List<BitcoinAddress>` — calls `listreceivedbyaddress` with `include_empty=true`

`BitcoinAddress` fields: address, amount, confirmations, txids

## Step 3: BlockchainService — Bitcoin Methods

Add `bitcoinClients: ConcurrentHashMap<String, BitcoinRpcClient>` cache.

Add methods following existing sealed-class result pattern:
- `getBalance()` — add Bitcoin branch: call `client.getBalance()`, convert to satoshis for `balanceWei`
- `sendBitcoin(toAddress, amount, network)` — if regtest, auto-call `setTxFee(0.00001)` before `sendToAddress()`
- `getBitcoinAddresses(network): BitcoinAddressesResult`
- `generateBitcoinAddress(network): BitcoinAddressResult`
- `getBitcoinTransactions(network, count): BitcoinTransactionsResult`

Add sealed result classes: `BitcoinAddressesResult`, `BitcoinAddressResult`, `BitcoinTransactionsResult`.

Update `invalidateNetwork()` and `shutdown()` to close Bitcoin clients.

## Step 4: WalletManager — Pseudo-Wallet

Bitcoin Core manages keys, so the plugin uses a pseudo-wallet (`address = "BITCOIN_CORE_CONNECTION"`) to fit existing architecture.

- Add `BITCOIN_CORE_ADDRESS` constant
- `ensureBitcoinCoreWallet()` — creates pseudo-wallet if not exists
- `isBitcoinCoreWallet(wallet)` — helper check
- Guard `createWallet()`, `importWallet()`, `exportPrivateKey()`, `deleteWallet()` — throw clear error for Bitcoin type

## Step 5: BitcoinAddressesPanel (New File)

Replaces `WalletSelectorBar` when Bitcoin network is selected. Shows:
- Header: "Bitcoin Core Wallet" + "Receiving Addresses" subtitle
- "Generate New Address" button in header
- Scrollable list of addresses with monospace font + Copy button per row
- Loading/error/empty states

Callbacks: `onGenerateNewAddress`, `onAddressCopied`

## Step 6: BitcoinActivityPanel (New File)

Replaces Activity tab placeholder when Bitcoin network is selected. Shows:
- Header: "Transaction History" + Refresh button
- Scrollable list of transactions, each row showing:
  - Category icon+label (Received/Sent/Mined) with green/red color
  - Shortened address (monospace)
  - Amount with sign (+/-) formatted to 8 decimals
  - Date + confirmations count
- Click row to see full transaction details dialog

Callbacks: `onRefreshClick`, `onTransactionClick`

## Step 7: MetaMaskToolWindow — Dynamic UI Switching

On network change, detect `BlockchainType.BITCOIN` and:

**`showBitcoinUI()`:**
1. Call `walletManager.ensureBitcoinCoreWallet()` and select it
2. Replace `walletSelectorBar` with `bitcoinAddressesPanel` in header
3. Replace Activity tab placeholder with `bitcoinActivityPanel` via `mainTabPanel`
4. Wire up event handlers (generate address, refresh tx, tx click)
5. Load addresses + transactions from Bitcoin Core
6. Hide "Add Token" button (Bitcoin has no tokens)

**`showStandardUI()`:**
1. Replace `bitcoinAddressesPanel` with `walletSelectorBar` in header
2. Restore Activity tab placeholder
3. Show "Add Token" button

**Wallet popup** — add `BITCOIN` case to `when(blockchainType)` blocks:
- Create label: "+ Create New Bitcoin Wallet" (but this should be disabled/hidden since Bitcoin Core manages wallets)
- Import label: disabled for Bitcoin
- Show message: "Bitcoin wallets are managed by Bitcoin Core"

## Step 8: MainTabPanel — Dynamic Content

Add methods:
- `replacePlaceholderWithBitcoin(panel)` — swap Activity tab content
- `restorePlaceholder()` — restore original placeholder
- `hideTokenAddButton()` / `showTokenAddButton()` — for Bitcoin mode

## Step 9: SendTokenDialog — Bitcoin Send

Add `isBitcoinNetwork` flag. In `setupForBlockchainType()`:
- Hide gas fields, token selector, fee limit
- Show "Fee: Calculated by Bitcoin Core"
- Mark gas as loaded

In `doOKAction()`:
- Add Bitcoin address validation (length 26-62)
- Route to `proceedWithBitcoinTransaction()` — no password needed (Bitcoin Core signs), confirm dialog, call `blockchainService.sendBitcoin()`

## Verification

1. `./gradlew build` — confirm compilation
2. Start Bitcoin Core regtest:
   ```bash
   bitcoind -regtest -daemon
   bitcoin-cli -regtest createwallet "test"
   bitcoin-cli -regtest generatetoaddress 101 $(bitcoin-cli -regtest getnewaddress)
   ```
3. Run plugin, select Bitcoin Regtest network
4. Test: balance loads, generate address, copy address, send BTC, view Activity tab
5. Switch to EVM network and back to verify UI switching works
6. Stop bitcoind to verify error handling
